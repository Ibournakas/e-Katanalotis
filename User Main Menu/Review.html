<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Αξιολόγηση Προσφοράς</title>

    <style>
        #offers{
            margin-top: 30px;
            text-align: center;
            padding: 3px 5px 3px;
            border-radius: 3px;
            background-color: rgba(52, 139, 232, 0.35); 
            display: grid;
            border:2px ridge black;}

        #offers_table{border-collapse: collapse;}

        tr{border-bottom: 2px ridge black;}

        td{ align-content: center;
            padding:7px;
        }
        
        .more_btn{
        font-size: 70%;}

        #thumbup:active, #thumbdown:focus{
            background-color: rgb(101, 8, 8)a(0, 0, 0, 0.4);
        }

        .more_btn:hover,.thumbup:hover, .thumbdown:hover, #stockupd:hover{
            cursor: pointer;
            color: rgba(0, 0, 0, 0.4);
        }
        
        .nostockthumbup, .nostockthumbdown{
            color: rgba(48, 34, 34, 0.4);
        }

        #prodimg{ 
            width: 85px; 
            height:auto;
            border-radius: 5px;
        }

        
    </style>

</head>
<body>
    <div id="offers"></div>

    <script>
        var poi_id = sessionStorage.getItem("poi_id"); //get id of selected POI
        let likes_click = Array();
        let dislikes_click = Array();
        
        xhttp = new XMLHttpRequest();
            xhttp.open("POST", "Review.php?functionToCall=getPoiOffers", true);
            xhttp.setRequestHeader("POI.id", "string");
            xhttp.onload = function() {
                if (this.readyState == 4 && this.status == 200) {  
                    document.getElementById("offers").innerHTML = this.responseText;

                    var elements = document.getElementsByClassName("more_btn");
                    var dlelements = document.getElementsByClassName("thumbdown");
                    var lelements = document.getElementsByClassName("thumbup");
                    
                    for (var i = 0; i < elements.length; i++) {
                        elements[i].addEventListener('click', getmoreinfo, false);
                        likes_click.push(0);
                        dislikes_click.push(0);
                    }   

                    for (var i = 0; i < dlelements.length; i++) {
                    dlelements[i].addEventListener('click',dislikehandler);
                    lelements[i].addEventListener('click',likehandler);}
                }
                };
        xhttp.send(poi_id);  

///if the 'more' or 'less' buttons are clicked, show or hide more info respectively
        var getmoreinfo = function(e) {
            // var flag = true;

            //if 'more' has been clicked for another offer, close the other offer
            // for(let i=1; i < document.getElementById("offers_table").rows.length; i++){  
            //     if(i==1) console.log(document.getElementById("offers_table").rows.length);
            //     console.log(document.getElementById("offers_table").rows[i].cells[8].innerHTML);
            //     let icon = document.getElementById("offers_table").rows[i].cells[8].innerHTML;
            //     console.log(icon);
            //     if(icon.textContent == 9650) {
            //         document.getElementById("offers_table").rows[i].cells[8].innerHTML = '&#x25BC';
            //         document.getElementById("offers_table").deleteRow(row.rowIndex+2);
            //         document.getElementById("offers_table").deleteRow(row.rowIndex+1);
            //         break
            //     }

            // }

            var row = e.target.parentElement; //get parent element of the clicked element, aka the selected row
            if(e.target.textContent.charCodeAt(0) == 9660){ //decimal value of the hex 'down-triangle' html entity
            //if(moreless.innerHTML =="Περισσότερα"){
                //moreless.innerHTML = "Λιγότερα";
                e.target.innerHTML = '&#x25B2';                

                xhttp = new XMLHttpRequest();
                xhttp.open("POST", "Review.php?functionToCall=getMoreInformation", true);
                xhttp.setRequestHeader("prod_info", "string");
                xhttp.onload = function() {
                    if (this.readyState == 4 && this.status == 200) {  
                        var new_row_header = document.getElementById("offers_table").insertRow(row.rowIndex+1);
                        var new_row_cont = document.getElementById("offers_table").insertRow(row.rowIndex+2);
                        new_row_header.insertCell(0).innerHTML = "<b>Φωτογραφία";
                        new_row_header.insertCell(1).innerHTML = "<b>Username"; 
                        new_row_header.insertCell(2).innerHTML ="<b>Συνολικό σκορ";
                        new_row_header.insertCell(3).innerHTML ="<b>Ενημέρωση αποθέματος";
                        new_row_cont.innerHTML = this.responseText;

                        // dlelements = document.getElementsByClassName("thumbdown");
                        // lelements = document.getElementsByClassName("thumbup");

                        // for (var i = 0; i < dlelements.length; i++) {
                        //     dlelements[i].addEventListener('click',dislikehandler);
                        //     lelements[i].addEventListener('click',likehandler);
                        // }

                        
                    }
                    };
                xhttp.send(row.firstChild.innerHTML);} //send the first child of the row, aka the offer id
            else {
                //moreless.innerHTML = "Περισσότερα";
                e.target.innerHTML = '&#x25BC';
                document.getElementById("offers_table").deleteRow(row.rowIndex+2);
                document.getElementById("offers_table").deleteRow(row.rowIndex+1);
            }
        };

        //handle pressing the dislike button
        function dislikehandler(e){
            var row = e.target.parentElement; //get parent element of the clicked element, aka the selected row
            console.log(row.rowIndex);

        }

        //handle pressing the like button
        function likehandler(e){
            var row = e.target.parentElement; //get parent element of the clicked element, aka the selected row
            //target_row = row.rowIndex - 2;
            //console.log(target_row);
            console.log(row);
            console.log(row.rowIndex);
            offer_id = document.getElementById("offers_table").rows[row.rowIndex].cells[0].innerHTML; //get the respective offer id
            //console.log(offer_id);
            console.log(offer_id);
            likescnt = document.getElementById("offers_table").rows[row.rowIndex].cells[2].innerHTML;
            console.log(likes_click[0]);
            if(likes_click[row.rowIndex-1] % 2 == 0)  //if even number of like clicks
                {likescnt++;
                 document.getElementById("offers_table").rows[row.rowIndex].cells[2].innerHTML = likescnt;
                }
            else    
                {likescnt--;
                document.getElementById("offers_table").rows[row.rowIndex].cells[2].innerHTML = likescnt;
                }

            likes_click[row.rowIndex-1]++;
            //var sel_row = row.firstChild.innerHTML; //get the first child of the above row, aka the offer id
            //alert(likes_click);
            //console.log(sel_row);

        }

        
    </script>
    
</body>
</html>